(function(){var a={};window.tributary=a,a.events=_.clone(Backbone.Events),a.data={},window.trib={},window.trib_options={},window.addEventListener("resize",function(b){a.events.trigger("resize",b)}),a.CodeModel=Backbone.Model.extend({defaults:{code:"",filename:"inlet.js",name:"inlet",type:"js",config:{coffee:!1,vim:!1,emacs:!1,hide:!1}},initialize:function(){this.binder()},binder:function(){this.on("error",this.handle_error)},handle_error:function(b){a.trace&&(console.trace(),console.log(b))},handle_coffee:function(){var a=this.get("code");return this.get("config").coffee&&(a=CoffeeScript.compile(a,{bare:!0})),a},local_storage:function(a){a||(a="");var b=this.get("filename")+"/code/"+a;return localStorage[b]},set_local_storage:function(a,b){var c=this.get("filename")+"/code/"+b;localStorage[c]=a}}),a.CodeModels=Backbone.Collection.extend({model:a.CodeModel}),a.Config=Backbone.Model.extend({defaults:{endpoint:"tributary","public":!0,require:[]},require:function(a,b){var c=this.get("require"),d=_.pluck(c,"url"),e=function(){return a(b,arguments)};require(d,e)}}),a.ConfigView=Backbone.View.extend({render:function(){}}),a.Context=Backbone.View.extend({initialize:function(){},execute:function(){},render:function(){}}),a.TributaryContext=a.Context.extend({initialize:function(){this.model.on("change:code",this.execute,this)},execute:function(){var b=this.model.handle_coffee(),c=this;try{a.initialize=new Function("g",b)}catch(d){return this.trigger("error",d),!1}try{window.trib={},window.trib_options={},trib=window.trib,trib_options=window.trib_options,$(this.el).children("svg").empty(),a.initialize(this.svg)}catch(e){return this.model.trigger("error",e),!1}return this.model.trigger("noerror"),!0},render:function(){this.svg=d3.select(this.el).append("svg").attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink","class":"tributary_svg"})}}),a.JSONContext=a.Context.extend({initialize:function(){this.model.on("code",this.execute,this)},execute:function(){try{var b=JSON.parse(this.model.get("code"));a[this.model.get("name")]=b}catch(c){return this.model.trigger("error",c),!1}return this.model.trigger("noerror"),!0},render:function(){}}),a.DeltaContext=Backbone.View.extend({initialize:function(){this.model.on("change:code",this.execute,this),this.pause=!0,this.reverse=!1,this.loop="period",this.bv=!1,this.nclones=15,this.clonse_opacity=.4,this.duration=3e3,this.t=0,this.ease=d3.ease("linear"),a.init=function(a,b,c){},a.run=function(a,b,c){};var b=this;b.timer={then:new Date,duration:b.duration,ctime:b.t},d3.timer(function(){if(b.pause)return!1;var c=new Date,d=c-b.timer.then,e;b.reverse?e=b.timer.ctime*d/b.timer.duration*-1:e=(1-b.timer.ctime)*d/b.timer.duration,b.t=b.timer.ctime+e;if(b.t>=1||b.t<=0||b.t==="NaN")b.loop==="period"?(b.t=0,b.timer.then=new Date,b.timer.duration=b.duration,b.timer.ctime=b.t,b.reverse=!1):b.loop==="pingpong"?(b.t=!b.reverse,b.timer.then=new Date,b.timer.duration=b.duration,b.timer.ctime=b.t,b.reverse=!b.reverse):b.t!==0&&(b.t=1,b.pause=!0);b.t===!0&&(b.t=1),b.t===!1&&(b.t=0),$("#slider").attr("value",b.t),a.run(b.g,b.ease(b.t),0)})},execute:function(){var b=this.model.handle_coffee();try{a.initialize=new Function("g",b),a.initialize()}catch(c){return this.model.trigger("error",c),!1}if(a.bv)try{$(this.clones.node()).empty(),this.make_clones()}catch(d){this.model.trigger("error",d)}try{window.trib={},window.trib_options={},trib=window.trib,trib_options=window.trib_options,$(this.g.node()).empty(),a.init(this.g,0),a.run(this.g,this.ease(this.t),0)}catch(e){return this.model.trigger("error",e),!1}return this.model.trigger("noerror"),!0},render:function(){this.svg=d3.select(this.el).append("svg").attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink","class":"tributary_svg"}),this.clones=this.svg.append("g").attr("id","clones"),this.g=this.svg.append("g").attr("id","delta")},make_clones:function(){var b=d3.range(this.nclones),c=this.clones.selectAll("g.bvclone").data(b).enter().append("g").attr("class","bvclone").style("opacity",this.clone_opacity);c.each(function(b,c){var d=c+1,e=d3.select(this);a.init(e,d);var f=this.ease(d/(this.nclones+1));a.run(e,f,d)})}}),a.Editor=Backbone.View.extend({initialize:function(){this.config=this.model.get("config")},render:function(){var a=this;d3.select(this.el).attr({"class":"editor"}),this.cm=CodeMirror(this.el,{mode:"javascript",theme:"lesser-dark",lineNumbers:!0,onChange:function(){var b=a.cm.getValue();a.model.set("code",b)}}),this.cm.setValue(this.model.get("code")),this.inlet=Inlet(this.cm),this.model.on("error",function(){d3.select(a.el).select(".CodeMirror-gutter").style({"border-right":"2px solid red"})}),this.model.on("noerror",function(){d3.select(a.el).select(".CodeMirror-gutter").style({"border-right":"1px solid #aaa"})})}}),a.gist=function(b,c){var d={},e="?cachebust="+Math.random()*0xf12765df4c9b2;d3.json("https://api.github.com/gists/"+b+e,function(b){b.user===null||b.user===undefined?d.user={login:"anon",url:"",userid:-1}:d.user=b.user;var e;try{e=b.files["config.json"]}catch(f){e=!1}if(e)try{d.config=new a.Config(JSON.parse(e.content))}catch(g){d.config=new a.Config}else d.config=new a.Config;var h=_.keys(b.files);d.models=new a.CodeModels;var i,j,k,l=0,m;h.forEach(function(c){i=c.split("."),m=i[i.length-1],c!=="config.json"&&(j=new a.CodeModel({filename:c,name:i[0],code:b.files[c].content,type:m}),d.models.add(j))}),d.config.require(c,d)})},a.FilesView=Backbone.View.extend({initialize:function(){},render:function(){}}),a.ControlsView=Backbone.View.extend({initialize:function(){},render:function(){}}),a.context_map={tributary:a.TributaryContext,delta:a.DeltaContext,cypress:a.CypressContext}})();