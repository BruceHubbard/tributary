(function(){var tributary={};window.tributary=tributary,tributary.events=_.clone(Backbone.Events),tributary.data={},window.trib={},window.trib_options={},window.addEventListener("resize",function(a){tributary.events.trigger("resize",a)}),tributary.CodeModel=Backbone.Model.extend({defaults:{code:"",filename:"inlet.js",name:"inlet",type:"js",config:{coffee:!1,vim:!1,emacs:!1,hide:!1}},initialize:function(){this.binder()},binder:function(){this.on("error",this.handle_error)},handle_error:function(a){tributary.trace&&(console.trace(),console.log(a))},handle_coffee:function(){var a=this.get("code");return this.get("config").coffee&&(a=CoffeeScript.compile(a,{bare:!0})),a},local_storage:function(a){a||(a="");var b=this.get("filename")+"/code/"+a;return localStorage[b]},set_local_storage:function(a,b){var c=this.get("filename")+"/code/"+b;localStorage[c]=a}}),tributary.CodeModels=Backbone.Collection.extend({model:tributary.CodeModel}),tributary.Config=Backbone.Model.extend({defaults:{endpoint:"tributary","public":!0,require:[]},require:function(a,b){var c=this.get("require"),d=_.pluck(c,"url"),e=function(){return a(b,arguments)};require(d,e)},initialize:function(){this.on("hide",function(){this.contexts.forEach(function(a){a.model.trigger("hide")})},this)}}),tributary.ConfigView=Backbone.View.extend({render:function(){var a=this;d3.select(this.el).append("span").classed("config_title",!0).text("Display:");var b=d3.select(this.el).append("div").classed("displays",!0).selectAll("div.config").data(tributary.displays).enter().append("div").classed("config",!0),c=this.model.get("display");b.each(function(a){console.log(a.name,c),a.name===c&&d3.select(this).classed("config_active",!0)}),b.append("span").text(function(a){return a.name}),b.append("span").text(function(a){return" "+a.description}).classed("description",!0),b.on("click",function(b){d3.select(this.parentNode).selectAll("div.config").classed("config_active",!1),d3.select(this).classed("config_active",!0),a.model.set("display",b.name)}),d3.select(this.el).append("span").classed("config_title",!0).text("Time Controls:");var d=d3.select(this.el).append("div").classed("timecontrols",!0).selectAll("div.config").data(tributary.time_controls).enter().append("div").classed("config",!0);d.each(function(a){}),d.append("span").text(function(a){return a.name}),d.append("span").text(function(a){return" "+a.description}).classed("description",!0),d.on("click",function(a){d3.select(this).classed("config_active",!d3.select(this).classed("config_active"))})}}),tributary.Context=Backbone.View.extend({initialize:function(){},execute:function(){},render:function(){}}),tributary.TributaryContext=tributary.Context.extend({initialize:function(){this.model.on("change:code",this.execute,this),tributary.events.on("execute",this.execute,this),this.config=this.options.config,this.config.on("change:display",this.set_display,this),tributary.init=undefined,tributary.run=undefined,tributary.pause=!0,tributary.reverse=!1,tributary.loop="period",tributary.bv=!1,tributary.nclones=15,tributary.clone_opacity=.4,tributary.duration=3e3,tributary.t=0,tributary.ease=d3.ease("linear"),tributary.render=function(){};var a=this;a.timer={then:new Date,duration:tributary.duration,ctime:tributary.t},d3.timer(function(){tributary.render();if(tributary.pause)return!1;var b=new Date,c=b-a.timer.then,d;a.reverse?d=a.timer.ctime*c/a.timer.duration*-1:d=(1-a.timer.ctime)*c/a.timer.duration,tributary.t=a.timer.ctime+d;if(tributary.loops){if(tributary.t>=1||tributary.t<=0||tributary.t==="NaN")a.loop==="period"?(tributary.t=0,a.timer.then=new Date,a.timer.duration=tributary.duration,a.timer.ctime=tributary.t,a.reverse=!1):a.loop==="pingpong"?(tributary.t=!a.reverse,a.timer.then=new Date,a.timer.duration=tributary.duration,a.timer.ctime=tributary.t,a.reverse=!a.reverse):tributary.t!==0&&(tributary.t=1,tributary.pause=!0);tributary.t===!0&&(tributary.t=1),tributary.t===!1&&(tributary.t=0),$("#slider").attr("value",tributary.t)}if(tributary.run!==undefined){var e=tributary.t;tributary.loops&&(e=tributary.ease(tributary.t)),tributary.run(a.g,e,0)}})},execute:function(){var js=this.model.handle_coffee(),that=this;try{eval(js)}catch(e){return this.model.trigger("error",e),!1}try{window.trib={},window.trib_options={},trib=window.trib,trib_options=window.trib_options,tributary.clear(),this.clones&&$(this.clones.node()).empty(),tributary.bv&&this.make_clones(),eval(js),tributary.autoinit&&tributary.init!==undefined&&tributary.init(this.g,0),tributary.run!==undefined&&tributary.run(this.g,tributary.ease(tributary.t),0)}catch(err){return this.model.trigger("error",err),!1}return this.model.trigger("noerror"),!0},render:function(){this.set_display()},set_display:function(){this.$el.empty();var a=this.config.get("display");a==="svg"?this.make_svg():a==="canvas"?this.make_canvas():a==="webgl"?this.make_webgl():a==="div"?tributary.clear=function(){this.$el.empty()}:tributary.clear=function(){this.$el.empty()}},make_svg:function(){this.svg=d3.select(this.el).append("svg").attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink","class":"tributary_svg"}),this.g=this.svg;var a=this;tributary.clear=function(){$(a.g.node()).empty()}},make_canvas:function(){tributary.clear=function(){tributary.canvas.width=tributary.sw,tributary.canvas.height=tributary.sh,tributary.ctx.clearRect(0,0,tributary.sw,tributary.sh)},tributary.canvas=d3.select(this.el).append("canvas").classed("tributary_canvas",!0).node(),tributary.ctx=tributary.canvas.getContext("2d"),this.g=tributary.ctx},make_clones:function(){this.clones=this.svg.selectAll("g.clones").data([0]),this.clones.enter().append("g").attr("class","clones"),this.g=this.svg.selectAll("g.delta").data([0]),this.g.enter().append("g").attr("class","delta");var a=d3.range(tributary.nclones),b=this.clones.selectAll("g.bvclone").data(a).enter().append("g").attr("class","bvclone").style("opacity",tributary.clone_opacity);b.each(function(a,b){var c=b+1,d=d3.select(this);tributary.init(d,c);var e=tributary.ease(c/(tributary.nclones+1));tributary.run(d,e,c)})},make_webgl:function(){function a(){windowHalfX=tributary.sw/2,windowHalfY=tributary.sh/2,tributary.camera.aspect=tributary.sw/tributary.sh,tributary.camera.updateProjectionMatrix(),tributary.renderer.setSize(tributary.sw,tributary.sh)}container=this.el,tributary.camera=new THREE.PerspectiveCamera(70,tributary.sw/tributary.sh,1,1e3),tributary.camera.position.y=150,tributary.camera.position.z=500,tributary.scene=new THREE.Scene,THREE.Object3D.prototype.clear=function(){var a=this.children,b;for(b=a.length-1;b>=0;b--){var c=a[b];c.clear(),this.remove(c)}},tributary.renderer=new THREE.WebGLRenderer,tributary.renderer.setSize(tributary.sw,tributary.sh),container.appendChild(tributary.renderer.domElement),tributary.render=function(){tributary.renderer.render(tributary.scene,tributary.camera)},tributary.render(),tributary.events.on("resize",a,!1),tributary.clear=function(){tributary.scene.clear()}}}),tributary.JSONContext=tributary.Context.extend({initialize:function(){this.model.on("change:code",this.execute,this),this.model.on("change:code",function(){console.log("execute???"),tributary.events.trigger("execute")})},execute:function(){try{var a=JSON.parse(this.model.get("code"));tributary[this.model.get("name")]=a}catch(b){return this.model.trigger("error",b),!1}return this.model.trigger("noerror"),!0},render:function(){}}),tributary.DeltaContext=Backbone.View.extend({initialize:function(){this.model.on("change:code",this.execute,this),this.pause=!0,this.reverse=!1,this.loop="period",this.bv=!1,this.nclones=15,this.clonse_opacity=.4,this.duration=3e3,this.t=0,this.ease=d3.ease("linear"),tributary.init=function(a,b,c){},tributary.run=function(a,b,c){};var a=this;a.timer={then:new Date,duration:a.duration,ctime:a.t},d3.timer(function(){if(a.pause)return!1;var b=new Date,c=b-a.timer.then,d;a.reverse?d=a.timer.ctime*c/a.timer.duration*-1:d=(1-a.timer.ctime)*c/a.timer.duration,a.t=a.timer.ctime+d;if(a.t>=1||a.t<=0||a.t==="NaN")a.loop==="period"?(a.t=0,a.timer.then=new Date,a.timer.duration=a.duration,a.timer.ctime=a.t,a.reverse=!1):a.loop==="pingpong"?(a.t=!a.reverse,a.timer.then=new Date,a.timer.duration=a.duration,a.timer.ctime=a.t,a.reverse=!a.reverse):a.t!==0&&(a.t=1,a.pause=!0);a.t===!0&&(a.t=1),a.t===!1&&(a.t=0),$("#slider").attr("value",a.t),tributary.run(a.g,a.ease(a.t),0)})},execute:function(){var a=this.model.handle_coffee();try{tributary.initialize=new Function("g",a),tributary.initialize()}catch(b){return this.model.trigger("error",b),!1}if(tributary.bv)try{$(this.clones.node()).empty(),this.make_clones()}catch(c){this.model.trigger("error",c)}try{window.trib={},window.trib_options={},trib=window.trib,trib_options=window.trib_options,$(this.g.node()).empty(),tributary.init(this.g,0),tributary.run(this.g,this.ease(this.t),0)}catch(d){return this.model.trigger("error",d),!1}return this.model.trigger("noerror"),!0},render:function(){this.svg=d3.select(this.el).append("svg").attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink","class":"tributary_svg"}),this.clones=this.svg.append("g").attr("id","clones"),this.g=this.svg.append("g").attr("id","delta")},make_clones:function(){var a=d3.range(this.nclones),b=this.clones.selectAll("g.bvclone").data(a).enter().append("g").attr("class","bvclone").style("opacity",this.clone_opacity);b.each(function(a,b){var c=b+1,d=d3.select(this);tributary.init(d,c);var e=this.ease(c/(this.nclones+1));tributary.run(d,e,c)})}}),tributary.Editor=Backbone.View.extend({initialize:function(){this.config=this.model.get("config"),this.model.on("show",function(){d3.select(this.el).style("display","")},this),this.model.on("hide",function(){d3.select(this.el).style("display","none")},this)},render:function(){var a=this;d3.select(this.el).attr({"class":"editor"}),this.cm=CodeMirror(this.el,{mode:"javascript",theme:"lesser-dark",lineNumbers:!0,onChange:function(){var b=a.cm.getValue();a.model.set("code",b)}}),this.cm.setValue(this.model.get("code")),this.inlet=Inlet(this.cm),this.model.on("error",function(){d3.select(a.el).select(".CodeMirror-gutter").classed("error",!0)}),this.model.on("noerror",function(){d3.select(a.el).select(".CodeMirror-gutter").classed("error",!1)})}}),tributary.gist=function(a,b){var c={},d="?cachebust="+Math.random()*0xf12765df4c9b2;d3.json("https://api.github.com/gists/"+a+d,function(a){a.user===null||a.user===undefined?c.user={login:"anon",url:"",userid:-1}:c.user=a.user;var d;try{d=a.files["config.json"]}catch(e){d=!1}if(d)try{c.config=new tributary.Config(JSON.parse(d.content))}catch(f){c.config=new tributary.Config}else c.config=new tributary.Config;var g=_.keys(a.files);c.models=new tributary.CodeModels;var h,i,j,k=0,l;g.forEach(function(b){h=b.split("."),l=h[h.length-1],b!=="config.json"&&(i=new tributary.CodeModel({filename:b,name:h[0],code:a.files[b].content,type:l}),c.models.add(i))}),c.config.require(b,c)})},tributary.FilesView=Backbone.View.extend({initialize:function(){},render:function(){var a=this,b=d3.select(this.el).selectAll("div").data(this.model.contexts),c=b.enter().append("div").classed("fv",!0);c.on("click",function(b){a.model.trigger("hide"),b.model.trigger("show"),tributary.events.trigger("show","edit")}),c.append("span").text(function(a){return a.model.get("filename")})}}),tributary.FileView=Backbone.View.extend({render:function(){}}),tributary.ControlsView=Backbone.View.extend({initialize:function(){},render:function(){}}),tributary.displays=[{name:"svg",description:"creates an <svg> element for you to use"},{name:"canvas",description:"creates a <canvas> element and gives you a Context for the canvas"},{name:"webgl",description:"gives you a Three.js WebGLRenderer scene"},{name:"div",description:"gives you a plain old <div>"}],tributary.time_controls=[{name:"play",description:"gives you a play button, and tributary.t. if you provide tributary.run(g,t) it will be executed in a run loop"},{name:"loop",description:"gives you a loop where tributary.t goes from 0 to 1."},{name:"restart",description:"assumes you only want tributary.init(g) to be run when the restart button is clicked"}],d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})}})();