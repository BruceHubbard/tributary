(function(){var a={};window.tributary=a,a.events=_.clone(Backbone.Events),a.data={},window.trib={},window.trib_options={},window.addEventListener("resize",function(b){a.events.trigger("resize",b)}),a.CodeModel=Backbone.Model.extend({defaults:{code:"",filename:"inlet.js",name:"inlet",type:"js",config:{coffee:!1,vim:!1,emacs:!1,hide:!1}},initialize:function(){this.binder()},binder:function(){this.on("error",this.handle_error)},handle_error:function(b){a.trace&&(console.trace(),console.log(b))},handle_coffee:function(){var a=this.get("code");return this.get("config").coffee&&(a=CoffeeScript.compile(a,{bare:!0})),a},local_storage:function(a){a||(a="");var b=this.get("filename")+"/code/"+a;return localStorage[b]},set_local_storage:function(a,b){var c=this.get("filename")+"/code/"+b;localStorage[c]=a}}),a.CodeModels=Backbone.Collection.extend({model:a.CodeModel}),a.Config=Backbone.Model.extend({defaults:{endpoint:"tributary","public":!0,require:[]},require:function(a,b){var c=this.get("require"),d=_.pluck(c,"url"),e=function(){return a(b,arguments)};require(d,e)}}),a.ConfigView=Backbone.View.extend({render:function(){}}),a.Context=Backbone.View.extend({initialize:function(){},execute:function(){},render:function(){}}),a.TributaryContext=a.Context.extend({initialize:function(){this.model.on("change:code",this.execute,this),this.config=this.options.config,a.init=undefined,a.run=undefined,a.pause=!0,a.reverse=!1,a.loop="period",a.bv=!1,a.nclones=15,a.clonse_opacity=.4,a.duration=3e3,a.t=0,a.ease=d3.ease("linear"),a.render=function(){};var b=this;b.timer={then:new Date,duration:a.duration,ctime:a.t},d3.timer(function(){a.render();if(a.pause)return!1;var c=new Date,d=c-b.timer.then,e;b.reverse?e=b.timer.ctime*d/b.timer.duration*-1:e=(1-b.timer.ctime)*d/b.timer.duration,a.t=b.timer.ctime+e;if(a.loops){if(a.t>=1||a.t<=0||a.t==="NaN")b.loop==="period"?(a.t=0,b.timer.then=new Date,b.timer.duration=a.duration,b.timer.ctime=a.t,b.reverse=!1):b.loop==="pingpong"?(a.t=!b.reverse,b.timer.then=new Date,b.timer.duration=a.duration,b.timer.ctime=a.t,b.reverse=!b.reverse):a.t!==0&&(a.t=1,a.pause=!0);a.t===!0&&(a.t=1),a.t===!1&&(a.t=0),$("#slider").attr("value",a.t)}if(a.run!==undefined){var f=a.t;a.loops&&(f=a.ease(a.t)),a.run(b.g,f,0)}})},execute:function(){var b=this.model.handle_coffee(),c=this;try{a.initialize=new Function("g",b),a.initialize(this.g)}catch(d){return this.model.trigger("error",d),!1}if(a.bv)try{$(this.clones.node()).empty(),this.make_clones()}catch(e){this.model.trigger("error",e)}try{window.trib={},window.trib_options={},trib=window.trib,trib_options=window.trib_options,a.clear(),a.initialize(this.g),a.autoinit&&a.init!==undefined&&a.init(this.g,0),a.run!==undefined&&a.run(this.g,a.ease(a.t),0)}catch(f){return this.model.trigger("error",f),!1}return this.model.trigger("noerror"),!0},render:function(){var b=this.config.get("display");b==="svg"?this.make_svg():b==="canvas"?this.make_canvas():b==="webgl"?this.make_webgl():b==="div"?a.clear=function(){this.$el.empty()}:a.clear=function(){this.$el.empty()}},make_svg:function(){this.svg=d3.select(this.el).append("svg").attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink","class":"tributary_svg"}),this.g=this.svg;var b=this;a.clear=function(){$(b.g.node()).empty()}},make_canvas:function(){a.clear=function(){a.canvas.width=a.sw,a.canvas.height=a.sh,a.ctx.clearRect(0,0,a.sw,a.sh)},a.canvas=d3.select(this.el).append("canvas").classed("tributary_canvas",!0).node(),a.ctx=a.canvas.getContext("2d"),this.g=a.ctx},make_clones:function(){this.clones=this.svg.append("g").attr("id","clones"),this.g=this.svg.append("g").attr("id","delta");var b=d3.range(a.nclones),c=this.clones.selectAll("g.bvclone").data(b).enter().append("g").attr("class","bvclone").style("opacity",a.clone_opacity);c.each(function(b,c){var d=c+1,e=d3.select(this);a.init(e,d);var f=a.ease(d/(a.nclones+1));a.run(e,f,d)})},make_webgl:function(){function b(){windowHalfX=a.sw/2,windowHalfY=a.sh/2,a.camera.aspect=a.sw/a.sh,a.camera.updateProjectionMatrix(),a.renderer.setSize(a.sw,a.sh)}container=this.el,a.camera=new THREE.PerspectiveCamera(70,a.sw/a.sh,1,1e3),a.camera.position.y=150,a.camera.position.z=500,a.scene=new THREE.Scene,THREE.Object3D.prototype.clear=function(){var a=this.children,b;for(b=a.length-1;b>=0;b--){var c=a[b];c.clear(),this.remove(c)}},a.renderer=new THREE.WebGLRenderer,a.renderer.setSize(a.sw,a.sh),container.appendChild(a.renderer.domElement),a.render=function(){a.renderer.render(a.scene,a.camera)},a.render(),a.events.on("resize",b,!1),a.clear=function(){a.scene.clear()}}}),a.JSONContext=a.Context.extend({initialize:function(){this.model.on("code",this.execute,this)},execute:function(){try{var b=JSON.parse(this.model.get("code"));a[this.model.get("name")]=b}catch(c){return this.model.trigger("error",c),!1}return this.model.trigger("noerror"),!0},render:function(){}}),a.DeltaContext=Backbone.View.extend({initialize:function(){this.model.on("change:code",this.execute,this),this.pause=!0,this.reverse=!1,this.loop="period",this.bv=!1,this.nclones=15,this.clonse_opacity=.4,this.duration=3e3,this.t=0,this.ease=d3.ease("linear"),a.init=function(a,b,c){},a.run=function(a,b,c){};var b=this;b.timer={then:new Date,duration:b.duration,ctime:b.t},d3.timer(function(){if(b.pause)return!1;var c=new Date,d=c-b.timer.then,e;b.reverse?e=b.timer.ctime*d/b.timer.duration*-1:e=(1-b.timer.ctime)*d/b.timer.duration,b.t=b.timer.ctime+e;if(b.t>=1||b.t<=0||b.t==="NaN")b.loop==="period"?(b.t=0,b.timer.then=new Date,b.timer.duration=b.duration,b.timer.ctime=b.t,b.reverse=!1):b.loop==="pingpong"?(b.t=!b.reverse,b.timer.then=new Date,b.timer.duration=b.duration,b.timer.ctime=b.t,b.reverse=!b.reverse):b.t!==0&&(b.t=1,b.pause=!0);b.t===!0&&(b.t=1),b.t===!1&&(b.t=0),$("#slider").attr("value",b.t),a.run(b.g,b.ease(b.t),0)})},execute:function(){var b=this.model.handle_coffee();try{a.initialize=new Function("g",b),a.initialize()}catch(c){return this.model.trigger("error",c),!1}if(a.bv)try{$(this.clones.node()).empty(),this.make_clones()}catch(d){this.model.trigger("error",d)}try{window.trib={},window.trib_options={},trib=window.trib,trib_options=window.trib_options,$(this.g.node()).empty(),a.init(this.g,0),a.run(this.g,this.ease(this.t),0)}catch(e){return this.model.trigger("error",e),!1}return this.model.trigger("noerror"),!0},render:function(){this.svg=d3.select(this.el).append("svg").attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink","class":"tributary_svg"}),this.clones=this.svg.append("g").attr("id","clones"),this.g=this.svg.append("g").attr("id","delta")},make_clones:function(){var b=d3.range(this.nclones),c=this.clones.selectAll("g.bvclone").data(b).enter().append("g").attr("class","bvclone").style("opacity",this.clone_opacity);c.each(function(b,c){var d=c+1,e=d3.select(this);a.init(e,d);var f=this.ease(d/(this.nclones+1));a.run(e,f,d)})}}),a.Editor=Backbone.View.extend({initialize:function(){this.config=this.model.get("config")},render:function(){var a=this;d3.select(this.el).attr({"class":"editor"}),this.cm=CodeMirror(this.el,{mode:"javascript",theme:"lesser-dark",lineNumbers:!0,onChange:function(){var b=a.cm.getValue();a.model.set("code",b)}}),this.cm.setValue(this.model.get("code")),this.inlet=Inlet(this.cm),this.model.on("error",function(){d3.select(a.el).select(".CodeMirror-gutter").classed("error",!0)}),this.model.on("noerror",function(){d3.select(a.el).select(".CodeMirror-gutter").classed("error",!1)})}}),a.gist=function(b,c){var d={},e="?cachebust="+Math.random()*0xf12765df4c9b2;d3.json("https://api.github.com/gists/"+b+e,function(b){b.user===null||b.user===undefined?d.user={login:"anon",url:"",userid:-1}:d.user=b.user;var e;try{e=b.files["config.json"]}catch(f){e=!1}if(e)try{d.config=new a.Config(JSON.parse(e.content))}catch(g){d.config=new a.Config}else d.config=new a.Config;var h=_.keys(b.files);d.models=new a.CodeModels;var i,j,k,l=0,m;h.forEach(function(c){i=c.split("."),m=i[i.length-1],c!=="config.json"&&(j=new a.CodeModel({filename:c,name:i[0],code:b.files[c].content,type:m}),d.models.add(j))}),d.config.require(c,d)})},a.FilesView=Backbone.View.extend({initialize:function(){},render:function(){}}),a.ControlsView=Backbone.View.extend({initialize:function(){},render:function(){}}),a.context_map={tributary:a.TributaryContext,delta:a.DeltaContext,cypress:a.CypressContext}})();